<html>
	<head>
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
		<link href="css/griddle.css" rel="stylesheet" />
		<link href="css/example.theme.css" rel="stylesheet" />
		<link href='http://fonts.googleapis.com/css?family=Oxygen' rel='stylesheet' type='text/css'>
		<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
		<script src="http://fb.me/react-0.12.0.js"></script>
		<script src="http://fb.me/JSXTransformer-0.12.0.js"></script>
		<script src="scripts/fakeData.js"></script>
		<script type="text/javascript" src="build/griddle.js"></script>
	</head>
	<body>
		<div id="hi"></div>
		<script type="text/jsx">
		var externalData = fakeData.slice(0, 53);

var ExternalFormatter = React.createClass({
	getDefaultProps: function(){
		return {
			getExternalResults: null,
			resultsPerPage: 5
		}
	},
    getInitialState: function(){
      var initial = { "results": [],
          "page": 0,
          "maxPage": 0,
          "externalSortColumn":null,
          "externalSortAscending":true,
          "pretendServerData": externalData
      };

      return initial;
    },
    componentDidMount: function(){
        this.setState({
        	"externalResultsPerPage": this.props.resultsPerPage,
            "maxPage": Math.round(this.state.pretendServerData.length/this.props.resultsPerPage),
            "results": this.state.pretendServerData.slice(0,this.props.resultsPerPage)
        })
    },
    setPage: function(index){
      //This should interact with the data source to get the page at the given index
      var number = index === 0 ? 0 : index * this.state.externalResultsPerPage;
      this.setState(
        {
          "results": this.state.pretendServerData.slice(number, number+5>this.state.pretendServerData.length ? this.state.pretendServerData.length : number+this.state.externalResultsPerPage),
          "page": index
        });
    },
    sortData: function(sort, sortAscending, data){
      //throw away method to do the sorting so that other functions can access
      //this should all happen on the server so please don't base anything off this code
      //it's purely to show that you can wrap Griddle and control what page it shows as and all that
      sortedData = _.sortBy(data, function(item){
        return item[sort];
      });

      if(sortAscending === false){
        sortedData.reverse();
      }
      return {
        "page": 0,
        "externalSortColumn": sort,
        "externalSortAscending": sortAscending,
        "pretendServerData": sortedData,
        "results": sortedData.slice(0,this.state.externalResultsPerPage)
      };
    },
    changeSort: function(sort, sortAscending){
      //this should change the sort for the given column
      this.setState(this.sortData(sort, sortAscending, this.state.pretendServerData));
    },
    setFilter: function(filter){
        /*
          like everything else -- this is pretend code used to simulate something that we would do on the
          server-side (aka we would generally post the filter as well as other information used to populate
          the grid) and send back to the view (which would handle passing the data back to Griddle)
        */

        var sortedData = this.sortData(this.state.externalSortColumn, this.state.externalSortAscending, externalData);

        if(filter === ""){
            this.setState(_.extend(sortedData, {maxPage: Math.round(sortedData.pretendServerData.length > this.state.externalResultsPerPage ? sortedData.pretendServerData.length/this.state.externalResultsPerPage : 1)}));

            return;
        }

        var filteredData = _.filter(sortedData.pretendServerData,
            function(item) {
                var arr = _.values(item);
                for(var i = 0; i < arr.length; i++){
                   if ((arr[i]||"").toString().toLowerCase().indexOf(filter.toLowerCase()) >= 0){
                    return true;
                   }
                }

                return false;
            });

        this.setState({
            pretendServerData: filteredData,
            maxPage: Math.round(filteredData.length > this.state.externalResultsPerPage ? filteredData.length/this.state.externalResultsPerPage : 1),
            "results": filteredData.slice(0,this.state.externalResultsPerPage)
        });
    },
    setPageSize: function(size){
        this.setState({
            page: 0,
            externalResultsPerPage: size,
            maxPage: Math.round(this.state.pretendServerData.length > size ? this.state.pretendServerData.length/size : 1),
            results: this.state.pretendServerData.slice(0,size)
        });
    },
    render: function(){
      return <Griddle useExternal={true} externalSetPage={this.setPage}
        externalChangeSort={this.changeSort} externalSetFilter={this.setFilter}
        externalSetPageSize={this.setPageSize} externalMaxPage={this.state.maxPage}
        externalCurrentPage={this.state.page} results={this.state.results} tableClassName="table" resultsPerPage={this.state.externalResultsPerPage}
        externalSortColumn={this.state.externalSortColumn} externalSortAscending={this.state.externalSortAscending} showFilter={true} showSettings={true} />
    }
});


			React.render(<ExternalFormatter />, document.getElementById("hi"));
		</script>
	</body>
</html>